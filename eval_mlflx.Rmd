---
title: "Evaluate mlflx"
author: "Beni Stocker"
date: "5/22/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(ggrepel)
library(yardstick)
library(rbeni)    # get it by devtools::install_github("https://github.com/stineb/rbeni.git")
library(ingestr)  # get it by devtools::install_github("https://github.com/computationales/ingestr.git")
library(cowplot)
```

## LSOCV metrics

### Read in

Obtain outputs

```{r}
df <- read_csv("data/LSTM_nocondition_results_apr22.csv")
usesites <- df$sitename %>% unique()

df <- read_csv("data/DNN_nocondition_results_apr22.csv") %>% 
  select(-GPP_NT_VUT_REF) %>% 
  right_join(df, by = c("sitename", "date")) %>% 
  rename(dnn_cond0 = dnn)

df %>% analyse_modobs2("lstm_cond0", "dnn_cond0", type = "hex")
```

<!-- OLD: -->
<!-- Obtain outputs with this [link on Notion](https://www.notion.so/computationales/Results-2a637978b16346f98ac8c8c018ee7549#68803d0d60ca4b35b331be78c695a97c). -->
<!-- ```{r} -->
<!-- df <- read_csv("data/df_pred_denormalised.csv")  # obtained from Notion -> mlflx DSLab -> Results -> -->
<!-- usesites <- df$sitename %>% unique() -->
<!-- ``` -->

```{r}
## Add P-model results
df <- df %>%
  left_join(
    read_csv("data/out_lsocv.csv") %>%
      dplyr::select(sitename, date, pmodel = mod),
    by = c("sitename", "date"))

# ## Add re-calculated RF results (see randomforest.Rmd)
# df_lsocv_rf <- read_rds("data/df_lsocv_rf.rds")
# df <- df %>%
#   left_join(
#     df_lsocv_rf %>%
#       dplyr::select(sitename, date, rf_pred = rf),
#     by = c("sitename", "date"))


# if (!exists("out_oob_FULL")){
#   load("~/eval_pmodel/calib_results/out_oob_FULL.Rdata")
# }
#
# ## for mlflx dslab course
# df <- out_oob_FULL %>%
#   purrr::map("gpp") %>%
#   purrr::map("fluxnet2015") %>%
#   purrr::map("data") %>%
#   purrr::map("ddf") %>%
#   bind_rows(.id = "sitename") %>%
#   select(sitename, date, pmodel = mod) %>%
#   right_join(df, by = c("sitename", "date"))
```

```{r eval=FALSE}
visdat::vis_miss(df, warn_large_data = FALSE, cluster = FALSE)

df %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(frac_missing = purrr::map_dbl(data, ~{1-(nrow(drop_na(., pmodel))) / nrow(.)}))
```

<!-- Get null model (gpp_null = c * fpar * SW_IN_F). This yields a constant c = 0.04381 (globally and temporally constant light use efficiency). Add gpp_null to df.  -->
<!-- ```{r} -->
<!-- df_train <- read_csv("data/ddf_combined_mlflx_20210510.csv") %>%  -->
<!--   mutate(apar = fpar * SW_IN_F) -->
<!-- # df_train <- read_csv("data/ddf_combined_mlflx_20210510.csv") -->

<!-- linmod <- lm(GPP_NT_VUT_REF ~ 0 + apar, data = df_train) -->

<!-- df <- df %>%  -->
<!--   left_join( -->
<!--     df_train %>%  -->
<!--       dplyr::select(-GPP_NT_VUT_REF), -->
<!--     by = c("sitename", "date")) %>%  -->
<!--   mutate(gpp_null = apar * linmod$coefficients[1]) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- df_oob_pmodel <- read_csv("~/mlflx/data/df_metrics_oob_stocker20gmd_fig2.csv") %>%  -->
<!--   filter(site %in% usesites) -->
<!-- ``` -->

### Daily 

#### LSOCV

Evaluation as means across predictions from the LSOCV.
```{r}
## LSOCV metrics df
df_lsocv_metrics <- df %>% 
  
  ## LSTM
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, lstm_cond0, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  dplyr::select(sitename, rsq_lstm = rsq) %>% 
  
  ## DNN
  left_join(
    df %>% 
      group_by(sitename) %>% 
      nest() %>% 
      mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, dnn_cond0, na_rm = TRUE))) %>% 
      mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
      dplyr::select(sitename, rsq_dnn = rsq),
    by = "sitename"
  ) %>% 
  
  # ## RF
  # left_join(
  #   df %>% 
  #     group_by(sitename) %>% 
  #     nest() %>% 
  #     mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, rf_pred, na_rm = TRUE))) %>% 
  #     mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  #     dplyr::select(sitename, rsq_rf = rsq),
  #   by = "sitename"
  # ) %>% 

  ## P-MODEL
  left_join(
    df %>% 
      group_by(sitename) %>% 
      nest() %>% 
      mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, pmodel, na_rm = TRUE))) %>% 
      mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
      dplyr::select(sitename, rsq_pmodel = rsq),
    by = "sitename"
  )
  
  # ## NULL MODEL
  # left_join(
  #   df %>% 
  #     group_by(sitename) %>% 
  #     nest() %>% 
  #     mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, gpp_null, na_rm = TRUE))) %>% 
  #     mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  #     dplyr::select(sitename, rsq_null = rsq),
  #   by = "sitename"
  # )


# LSTM
df %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, lstm_cond0, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# DNN
df %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, dnn_cond0, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# # RF
# df %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, rf_pred, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean(na.rm = TRUE)

# P-model
df %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, pmodel, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean(na.rm = TRUE)

# # NULL
# df %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., GPP_NT_VUT_REF, gpp_null, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean()
```

Benchmark plots
```{r}
## lstm
gg1 <- df_lsocv_metrics %>% 
  ggplot(aes(rsq_pmodel, rsq_lstm, label = sitename)) +
  geom_point(color = "red") +
  xlim(0,1) + ylim(0,1) +
  geom_abline(yintercept = 0, slope = 1, linetype = "dotted") +
  theme_classic() +
  labs(x = bquote( "P-model" ~ italic(R)^2),
       y = bquote( "LSTM" ~ italic(R)^2),
       title = "LSTM") +
  geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5)

## dnn
gg2 <- df_lsocv_metrics %>% 
  ggplot(aes(rsq_pmodel, rsq_dnn, label = sitename)) +
  geom_point(color = "red") +
  xlim(0,1) + ylim(0,1) +
  geom_abline(yintercept = 0, slope = 1, linetype = "dotted") +
  theme_classic() +
  labs(x = bquote( "P-model" ~ italic(R)^2),
       y = bquote( "DNN" ~ italic(R)^2),
       title = "DNN") +
  geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5)

# ## rf
# gg3 <- df_lsocv_metrics %>% 
#   ggplot(aes(rsq_null, rsq_rf, label = sitename)) +
#   geom_point(color = "red") +
#   xlim(0,1) + ylim(0,1) +
#   geom_abline(yintercept = 0, slope = 1, linetype = "dotted") +
#   theme_classic() +
#   labs(x = bquote( "NULL model" ~ italic(R)^2),
#        y = bquote( "RF" ~ italic(R)^2),
#        title = "RF") +
#   geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5)

# ## for p-model
# gg3 <- df_lsocv_metrics %>% 
#   ggplot(aes(rsq_null, rsq_pmodel, label = sitename)) +
#   geom_point(color = "red") +
#   xlim(0,1) + ylim(0,1) +
#   geom_abline(yintercept = 0, slope = 1, linetype = "dotted") +
#   theme_classic() +
#   labs(x = bquote( "NULL model" ~ italic(R)^2),
#        y = bquote( "P-model" ~ italic(R)^2),
#        title = "P-model") +
#   geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5)

plot_grid(gg1, gg2, labels = c("a", "b"))
ggsave("fig/lsocv_benchmarking.pdf", width = 10, height = 5)
```


#### All data pooled

```{r}
out_lstm <- df %>% 
  analyse_modobs2("lstm_cond0", "GPP_NT_VUT_REF", type = "hex", plot_legend = FALSE)
out_dnn <- df %>% 
  analyse_modobs2("dnn_cond0", "GPP_NT_VUT_REF", type = "hex", plot_legend = FALSE)
out_pmodel <- df %>%
  analyse_modobs2("pmodel", "GPP_NT_VUT_REF", type = "hex", plot_legend = FALSE)
# out_rf <- df %>% 
#   analyse_modobs2("rf_pred", "GPP_NT_VUT_REF", type = "hex", plot_legend = FALSE)
# out_null <- df %>% 
#   analyse_modobs2("gpp_null", "GPP_NT_VUT_REF", type = "hex", plot_legend = FALSE)

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")
gg3 <- out_pmodel$gg +
  labs(title = "P-model")
# gg3 <- out_rf$gg +
#   labs(title = "RF")
# gg4 <- out_null$gg +
#   labs(title = "NULL")

gg1 + gg2 + gg3 # + gg4
```

### Example time series

#### AU-DaP

```{r}
df %>% 
  dplyr::filter(sitename == "AU-DaP" & lubridate::year(date) %in% c(2009)) %>% 
  rename(lstm = lstm_cond0, dnn = dnn_cond0, pmodel = pmodel, obs = GPP_NT_VUT_REF) %>% 
  pivot_longer(c(obs, lstm, dnn, pmodel),
               names_to = "model", 
               values_to = "gpp") %>% 
  ggplot(aes(date, gpp, color = model)) +
  scale_color_manual(
    values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black", "pmodel" = "grey70"),
    labels = c("DNN", "LSTM", "obs.", "P-model")
    ) +
  geom_line() +
  labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
       x = "Date",
       title = "AU-DaP") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted")
```

#### AU-Whr

```{r}
df %>% 
  dplyr::filter(sitename == "AU-Whr" & lubridate::year(date) %in% c(2013)) %>% 
  rename(lstm = lstm_cond0, dnn = dnn_cond0, pmodel = pmodel, obs = GPP_NT_VUT_REF) %>% 
  pivot_longer(c(obs, lstm, dnn, pmodel),
               names_to = "model", 
               values_to = "gpp") %>% 
  ggplot(aes(date, gpp, color = model)) +
  scale_color_manual(
    values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black", "pmodel" = "grey70"),
    labels = c("DNN", "LSTM", "obs.", "P-model")
    ) +
  geom_line() +
  labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
       x = "Date",
       title = "AU-Whr") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted")
```

#### AU-How

```{r}
df %>% 
  dplyr::filter(sitename == "AU-How" 
                & lubridate::year(date) %in% 2005:2008
                ) %>% 
  rename(lstm = lstm_cond0, dnn = dnn_cond0, pmodel = pmodel, obs = GPP_NT_VUT_REF) %>% 
  pivot_longer(c(obs, lstm, dnn, pmodel),
               names_to = "model", 
               values_to = "gpp") %>% 
  ggplot(aes(date, gpp, color = model)) +
  scale_color_manual(
    values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black", "pmodel" = "grey70"),
    labels = c("DNN", "LSTM", "obs.", "P-model")
    ) +
  geom_line() +
  labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
       x = "Date",
       title = "AU-Whr") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted")
```

### Seasonal

```{r}
df_season <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  group_by(sitename, doy) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), 
            lstm = mean(lstm_cond0, na.rm = TRUE), 
            dnn = mean(dnn_cond0, na.rm = TRUE),
            pmodel = mean(pmodel, na.rm = TRUE)
            # rf = mean(rf_pred, na.rm = TRUE),
            # null = mean(gpp_null, na.rm = TRUE),
            # wscal = mean(wscal, na.rm = TRUE)
            )
```

<!-- Practically o missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_season) -->
<!-- ``` -->

Agreement of mean seasonal cycles.
```{r}
out_lstm <- df_season %>% rbeni::analyse_modobs2("lstm", "obs", type = "hex", plot_legend = FALSE)
out_dnn <- df_season %>% rbeni::analyse_modobs2("dnn", "obs", type = "hex", plot_legend = FALSE)
out_pmodel <- df_season %>% rbeni::analyse_modobs2("pmodel", "obs", type = "hex", plot_legend = FALSE)
# out_rf <- df_season %>% rbeni::analyse_modobs2("rf", "obs", type = "hex", plot_legend = FALSE)
# out_null <- df_season %>% rbeni::analyse_modobs2("null", "obs", type = "hex", plot_legend = FALSE)

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")
gg3 <- out_pmodel$gg +
  labs(title = "P-model")
# gg3 <- out_rf$gg +
#   labs(title = "RF")
# gg4 <- out_null$gg +
#   labs(title = "NULL")

gg1 + gg2 + gg3  # + gg4

ggsave("fig/modobs_seasonal.pdf", width = 9, height = 4)
```

Nash-Sutcliffe Efficiency (for comparison to Besnard et al., 2019: they had 0.66)
```{r}
hydroGOF::NSE(df_season$lstm, df_season$obs, na.rm = TRUE)
hydroGOF::NSE(df_season$dnn, df_season$obs, na.rm = TRUE)
# hydroGOF::NSE(df_season$rf, df_season$obs, na.rm = TRUE)
hydroGOF::NSE(df_season$pmodel, df_season$obs, na.rm = TRUE)
# hydroGOF::NSE(df_season$null, df_season$obs, na.rm = TRUE)
```

Evaluation as means across predictions from the LSOCV.
```{r}
# LSTM
df_season %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs, lstm, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# DNN
df_season %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs, dnn, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# # RF
# df_season %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs, rf, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean(na.rm = TRUE)

# P-model
df_season %>%
  group_by(sitename) %>%
  nest() %>%
  mutate(out = purrr::map(data, ~rsq(., obs, pmodel, na_rm = TRUE))) %>%
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>%
  pull(rsq) %>%
  mean(na.rm = TRUE)

# # NULL
# df_season %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs, null, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean()
```

#### By climate zone

```{r}
df_season_kgclimate <- df %>% 
  left_join(
    siteinfo_fluxnet2015,
    by = "sitename"
  ) %>%
  mutate(doy = lubridate::yday(date),
         northsouth = ifelse(lat>0, "North", "South")) %>% 
  dplyr::filter(koeppen_code != "-") %>%
  mutate(kg_code_northsouth = paste(koeppen_code, northsouth)) %>% 
  group_by(kg_code_northsouth, doy) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), lstm = mean(lstm_cond0, na.rm = TRUE), dnn = mean(dnn_cond0, na.rm = TRUE))
```

Seasonal course by climate zone: LSTM works much better.
```{r}
df_season_kgclimate %>% 
  pivot_longer(c(obs, lstm, dnn), names_to = "Source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = Source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black"), labels = c("DNN", "LSTM", "obs.")) +
  labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
       x = "Day of year") +
  facet_wrap(~kg_code_northsouth)

ggsave("fig/meanseasonalcycle_by_climate.pdf", width = 9, height = 6)
```

LSTM performs better in different aspects, possibly due to different processes inducing different temporal dependencies in different climate zones. DNN (but not or to a lesser degree LSTM) simulates:

- Aw (tropical savannah): too early recovery of GPP in wet season.
- Cfa (temperate, no dry season, hot summer), Dfb (Cold, no dry season, warm summer), Dfc (Cold, no dry season, cold summer): too early recovery of GPP in spring
- Csa (temperate, dry summer, hot summer): underestimating peak GPP, not fast enough depression of GPP after peak season

These are exemplified by looking at individual sites.

- Aw (tropical savannah): too early recovery of GPP in wet season.

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  dplyr::filter(koeppen_code %in% c("Aw")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

- Cfa (temperate, no dry season, hot summer), Dfb (Cold, no dry season, warm summer), Dfc (Cold, no dry season, cold summer): too early recovery of GPP in spring

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  dplyr::filter(koeppen_code %in% c("Cfa", "Dfb", "Dfc")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```
Special examples:
```{r}
siteinfo_fluxnet2015 %>% 
  dplyr::filter(sitename %in% c("US-PFa", "US-UMd"))
df_season %>% 
  dplyr::filter(sitename %in% c("US-PFa", "US-UMd")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```


- Csa (temperate, dry summer, hot summer): underestimating peak GPP, not fast enough depression of GPP after peak season

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  dplyr::filter(koeppen_code == "Csa") %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

Special examples:
```{r}
siteinfo_fluxnet2015 %>% 
  dplyr::filter(sitename %in% c("FR-Pue", "US-Var"))
df_season %>% 
  dplyr::filter(sitename %in% c("FR-Pue", "US-Var")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

#### By site

```{r}
df_season %>% 
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename, ncol = 4)
ggsave("fig/meanseasonalcycle_by_site.pdf", width = 9, height = 20)
```

<!-- Create a table for identifying climate zones -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE} -->
<!-- ## determine which zones to plot -->
<!-- df_zones_used <- ingestr::siteinfo_fluxnet2015 %>%  -->
<!--   dplyr::filter( sitename %in% usesites ) %>%  -->
<!--   mutate( hemisphere = ifelse( lat>0, "north", "south" ) ) %>%  -->
<!--   dplyr::select(sitename, koeppen_code, hemisphere) %>%  -->
<!--   group_by( koeppen_code, hemisphere ) %>% -->
<!--   nest() %>% -->
<!--   mutate(nsites = purrr::map_int(data, ~nrow(.))) %>%  -->

<!--   left_join( dplyr::rename( rsofun::koeppen_legend, koeppen_code = Code ), by = "koeppen_code" )%>% -->
<!--   arrange( -nsites ) %>%  -->
<!--   mutate(climatezone = paste(koeppen_code, hemisphere)) %>%  -->
<!--   filter(!(koeppen_code=="ET")) %>%  -->
<!--   ungroup() -->

<!-- df_rosetta <- tibble( -->
<!--   climatezone = c("Aw south", "BSk north", "Cfa north", "Cfb north", "Cfb south", "Csa north", "Csb north", "Dfb north", "Dfc north", "ET"), -->
<!--   label = c("Tropical savannah, dry winter, SH", "Arid steppe, cold", "Warm tem., fully humid, hot summer", "Warm tem., fully humid, warm summer", -->
<!--     "Warm tem., fully humid, warm summer, SH", "Warm tem., dry and hot summer", "Warm tem., dry and warm summer", "Cold, fully humid, warm summer",  -->
<!--     "Cold, fully humid, cold summer", "Polar tundra" )  ) -->

<!-- save(df_rosetta, file = "./data/df_rosetta.Rdata") -->

<!-- list_rosetta <- c( -->
<!--   "Aw south"  = "Tropical savannah, dry winter, SH",  -->
<!--   "BSk north" = "Arid steppe, cold",  -->
<!--   "Cfa north" = "Warm tem., fully humid, hot summer",  -->
<!--   "Cfb north" = "Warm tem., fully humid, warm summer", -->
<!--   "Cfb south" = "Warm tem., fully humid, warm summer, SH",  -->
<!--   "Csa north" = "Warm tem., dry and hot summer",  -->
<!--   "Csb north" = "Warm tem., dry and warm summer",  -->
<!--   "Dfb north" = "Cold, fully humid, warm summer",  -->
<!--   "Dfc north" = "Cold, fully humid, cold summer",  -->
<!--   "ET"        = "Polar tundra") -->

<!-- getname_climatezone <- function(myclimatezone){ -->
<!--   load("./data/df_rosetta.Rdata") -->
<!--   df_rosetta %>%  -->
<!--     dplyr::filter(climatezone==myclimatezone) %>%  -->
<!--     dplyr::select(label) %>%  -->
<!--     unlist() -->
<!-- } -->

<!-- df_zones_used %>%  -->
<!--   xtable::xtable( caption = "Caption text", auto = TRUE ) %>% -->
<!--   print( hline.after=c(-1, 0), file = "./tab/table_nsites_kgclimate.tex" ) -->
<!-- ``` -->


### Daily anomalies

Anomalies from mean seasonal cycle.

```{r}
df_anom <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  rename(P_MODEL = pmodel) %>% 
  left_join(df_season,
            by = c("sitename", "doy")) %>% 
  mutate(obs_anom = GPP_NT_VUT_REF - obs,
         lstm_anom = lstm_cond0 - lstm,
         dnn_anom = dnn_cond0 - dnn,
         # rf_anom = rf_pred - rf,
         pmodel_anom = P_MODEL - pmodel
         # null_anom = gpp_null - null
         )

out_lstm <- df_anom %>% 
  dplyr::select(mod = lstm_anom, obs = obs_anom) %>% 
  analyse_modobs2("mod", "obs", type = "hex", plot_legend = FALSE)
out_dnn  <- df_anom %>% 
  dplyr::select(mod = dnn_anom, obs = obs_anom) %>% 
  analyse_modobs2("mod", "obs", type = "hex", plot_legend = FALSE)
out_pmodel  <- df_anom %>% 
  dplyr::select(mod = pmodel_anom, obs = obs_anom) %>% 
  analyse_modobs2("mod", "obs", type = "hex", plot_legend = FALSE)
# out_rf  <- df_anom %>% 
#   dplyr::select(mod = rf_anom, obs = obs_anom) %>% 
#   analyse_modobs2("mod", "obs", type = "hex", plot_legend = FALSE)
# out_null  <- df_anom %>% 
#   dplyr::select(mod = null_anom, obs = obs_anom) %>% 
#   analyse_modobs2("mod", "obs", type = "hex", plot_legend = FALSE)

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")
gg3 <- out_pmodel$gg +
  labs(title = "P-model")
# gg3 <- out_rf$gg +
#   labs(title = "RF")
# gg4 <- out_null$gg +
#   labs(title = "NULL")

gg1 + gg2 + gg3  # + gg4

hydroGOF::NSE(df_anom$lstm_anom, df_anom$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_anom$dnn_anom,  df_anom$obs_anom, na.rm = TRUE)
# hydroGOF::NSE(df_anom$rf_anom,  df_anom$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_anom$pmodel_anom,  df_anom$obs_anom, na.rm = TRUE)
# hydroGOF::NSE(df_anom$null_anom, df_anom$obs_anom, na.rm = TRUE)
```


Evaluation as means across predictions from the LSOCV.
```{r}
# LSTM
df_anom %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs_anom, lstm_anom, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# DNN
df_anom %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs_anom, dnn_anom, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean()

# P-model
df_anom %>%
  group_by(sitename) %>%
  nest() %>%
  mutate(out = purrr::map(data, ~rsq(., obs_anom, pmodel_anom, na_rm = TRUE))) %>%
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>%
  pull(rsq) %>%
  mean(na.rm = TRUE)

# # RF
# df_anom %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs_anom, rf_anom, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean(na.rm = TRUE)
# 
# # NULL
# df_anom %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs_anom, null_anom, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean()
```

<!-- ```{r} -->
<!-- out_msc  <- df_anom %>% rbeni::analyse_modobs2("obs", "GPP_NT_VUT_REF", type = "hex") -->
<!-- out_msc$gg -->

<!-- gg1 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, lstm)) + -->
<!--   geom_line(aes(date, GPP_NT_VUT_REF), color = "red", alpha = 0.5) -->

<!-- gg2 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, obs_anom)) -->

<!-- gg3 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, lstm_anom)) -->

<!-- gg1 / gg2 / gg3 -->

<!-- df_anom %>%  -->
<!--   ggplot(aes(obs_anom, lstm_anom)) + -->
<!--   geom_point(alpha = 0.2) -->

<!-- df_anom %>%  -->
<!--   dplyr::select(mod = lstm_anom, obs = obs_anom) %>%  -->
<!--   analyse_modobs2("mod", "obs", type = "hex") -->
<!-- ``` -->


### Across-site

Get site means
```{r}
df_site <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  group_by(sitename) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), 
            lstm = mean(lstm_cond0, na.rm = TRUE), 
            dnn = mean(dnn_cond0, na.rm = TRUE),
            # rf = mean(rf_pred, na.rm = TRUE),
            pmodel = mean(pmodel, na.rm = TRUE)
            # null = mean(gpp_null, na.rm = TRUE)
            )
```

<!-- No missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_site) -->
<!-- ``` -->

Agreement of site means
```{r}
out_lstm <- df_site %>% 
  rbeni::analyse_modobs2("lstm", "obs")
out_dnn <- df_site %>% 
  rbeni::analyse_modobs2("dnn", "obs")
# out_rf <- df_site %>% 
#   rbeni::analyse_modobs2("rf", "obs")
out_pmodel <- df_site %>% 
  rbeni::analyse_modobs2("pmodel", "obs")
# out_null <- df_site %>% 
#   rbeni::analyse_modobs2("null", "obs")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")
gg3 <- out_pmodel$gg +
  labs(title = "P-model")
# gg3 <- out_rf$gg +
#   labs(title = "RF")
# gg4 <- out_null$gg +
#   labs(title = "NULL")

gg1 + gg2 + gg3  #  + gg4
```

Nash-Sutcliffe Efficiency (for comparison to Besnard et al., 2019: they had 0.42)
```{r}
hydroGOF::NSE(df_site$lstm, df_site$obs, na.rm = TRUE)
hydroGOF::NSE(df_site$dnn, df_site$obs, na.rm = TRUE)
# hydroGOF::NSE(df_site$rf, df_site$obs, na.rm = TRUE)
hydroGOF::NSE(df_site$pmodel, df_site$obs, na.rm = TRUE)
# hydroGOF::NSE(df_site$null, df_site$obs, na.rm = TRUE)
```


### Annual

Get site means
```{r}
df_ann <- df %>%
  rename(P_MODEL = pmodel) %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  ## fill with mean seasonal cycle for missing observations
  left_join(df_season %>% 
              rename(obs_meandoy = obs, 
                     lstm_meandoy = lstm, 
                     pmodel_meandoy = pmodel, 
                     # rf_meandoy = rf, 
                     # null_meandoy = null, 
                     dnn_meandoy = dnn
                     ), 
            by = c("sitename", "doy")) %>% 
  mutate(GPP_NT_VUT_REF = ifelse(is.na(GPP_NT_VUT_REF), obs_meandoy, GPP_NT_VUT_REF)
         # rf_pred = ifelse(is.na(rf_pred), rf_meandoy, rf_pred)
         ) %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(sitename, year) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = FALSE), 
            lstm = mean(lstm_cond0, na.rm = FALSE), 
            # rf = mean(rf_pred, na.rm = FALSE), 
            pmodel = mean(P_MODEL, na.rm = FALSE), 
            # null = mean(gpp_null, na.rm = FALSE), 
            dnn = mean(dnn_cond0, na.rm = FALSE)
            )
```

<!-- No missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_ann) -->
<!-- ``` -->

### Annual anomalies

```{r}
df_ann <- df_ann %>% 
  left_join(df_ann %>% 
              group_by(sitename) %>% 
              summarise(obs_mean = mean(obs, na.rm = TRUE), 
                        lstm_mean = mean(lstm, na.rm = TRUE), 
                        # null_mean = mean(null, na.rm = TRUE), 
                        # rf_mean = mean(rf, na.rm = TRUE), 
                        pmodel_mean = mean(pmodel, na.rm = TRUE), 
                        dnn_mean = mean(dnn, na.rm = TRUE)),
            by = c("sitename")) %>% 
  mutate(obs_anom = obs - obs_mean,
         lstm_anom = lstm - lstm_mean,
         # null_anom = null - null_mean,
         # rf_anom = rf - rf_mean,
         pmodel_anom = pmodel - pmodel_mean,
         dnn_anom = dnn - dnn_mean)

out_lstm <- df_ann %>% 
  dplyr::select(mod = lstm_anom, obs = obs_anom) %>% 
  rbeni::analyse_modobs2("mod", "obs")
out_dnn <- df_ann %>% 
  dplyr::select(mod = dnn_anom, obs = obs_anom) %>% 
  rbeni::analyse_modobs2("mod", "obs")
# out_rf <- df_ann %>% 
#   dplyr::select(mod = rf_anom, obs = obs_anom) %>% 
#   rbeni::analyse_modobs2("mod", "obs")
out_pmodel <- df_ann %>% 
  dplyr::select(mod = pmodel_anom, obs = obs_anom) %>% 
  rbeni::analyse_modobs2("mod", "obs")
# out_null <- df_ann %>% 
#   dplyr::select(mod = null_anom, obs = obs_anom) %>% 
#   rbeni::analyse_modobs2("mod", "obs")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")
gg3 <- out_pmodel$gg +
  labs(title = "P-model")
# gg3 <- out_rf$gg +
#   labs(title = "RF")
# gg4 <- out_null$gg +
#   labs(title = "NULL")

gg1 + gg2 + gg3 # + gg4
```

Besnard et al; 0.07
```{r}
hydroGOF::NSE(df_ann$lstm_anom, df_ann$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_ann$dnn_anom, df_ann$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_ann$pmodel_anom, df_ann$obs_anom, na.rm = TRUE)
# hydroGOF::NSE(df_ann$null_anom, df_ann$obs_anom, na.rm = TRUE)
```


Evaluation as means across predictions from the LSOCV.
```{r}
# LSTM
df_ann %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs_anom, lstm_anom, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean(na.rm = TRUE)

# DNN
df_ann %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(out = purrr::map(data, ~rsq(., obs_anom, dnn_anom, na_rm = TRUE))) %>% 
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
  pull(rsq) %>% 
  mean(na.rm = TRUE)

# P-model
df_ann %>%
  group_by(sitename) %>%
  nest() %>%
  mutate(out = purrr::map(data, ~rsq(., obs_anom, pmodel_anom, na_rm = TRUE))) %>%
  mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>%
  pull(rsq) %>%
  mean(na.rm = TRUE)

# # RF
# df_ann %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs_anom, rf_anom, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean(na.rm = TRUE)
# 
# # NULL
# df_ann %>% 
#   group_by(sitename) %>% 
#   nest() %>% 
#   mutate(out = purrr::map(data, ~rsq(., obs_anom, null_anom, na_rm = TRUE))) %>% 
#   mutate(rsq = purrr::map_dbl(out, ~pull(., .estimate))) %>% 
#   pull(rsq) %>% 
#   mean(na.rm = TRUE)
```

## LGOCV: Vegetation type

```{r}
## code from lvocv.R
## old:
# dbf <- read_csv("data/DBF.csv")
# mf <- read_csv("data/MF.csv")
# gra <- read_csv("data/GRA.csv")
# enf <- read_csv("data/ENF.csv")

# dbf <- read_csv("data/train_DBF.csv")
# mf <- read_csv("data/df_trainMF.csv")

## This is a misnomer: leave-DBF-out means that it was trained on DBF and tested on all other
targetveg <- "DBF"

## a site in DBF
targetsite <- "DE-Hai"

## collect predictions of model trained on remaining DBF sites
df <- read_delim(
  paste0("data/leave_", targetveg, "_out/", targetsite, "_test_bias.csv"), 
  delim = "\t", 
  col_names = c("sitename", "date", "bias")
  )

## collect predictions of model trained on GRA, and predicting on DE-Hai. 
## since DE-Hai is DBF, multiple models trained on GRA predicted DE-Hai, each one with a different GRA site held out from training.
collect_otherveg_bysite_byveg <- function(otherveg, targetveg, targetsite){
  
  purrr::map_dfr(
    as.list(list.files(path = paste0("data/leave_", otherveg, "_out"), pattern = targetveg)),
    ~read_delim(
      paste0("data/leave_", otherveg, "_out/", .), 
      delim = "\t", 
      col_names = c("sitename", "date", "bias")) %>% 
      filter(sitename == targetsite)
    ) %>% 
    group_by(sitename, date) %>% 
    summarise(bias = mean(bias, na.rm = TRUE)) %>% 
    mutate(trainedonveg = otherveg, isveg = targetveg)
  
}

all_vegtypes <- c("DBF", "ENF", "GRA", "MF")
df <- data.frame()

for (targetveg in all_vegtypes){

  ## get all sites of this veg type
  all_sites <- list.files(path = paste0("data/leave_", targetveg, "_out")) %>% 
    str_sub(start = 1, end = 6) %>% 
    unique()
  
  for (targetsite in all_sites){
    
    ## collect predictions of model trained on remaining sites of the same veg type (targetveg)
    df <- df %>% 
      bind_rows(
        read_delim(
          paste0("data/leave_", targetveg, "_out/", targetsite, "_test_bias.csv"), 
          delim = "\t", 
          col_names = c("sitename", "date", "bias")
          ) %>% 
        mutate(trainedonveg = targetveg, isveg = targetveg)
        )

    ## Collect predictions of model trained on all other veg types, and predicting on target site.
    ## Multiple models trained on each other veg predicted for this target site, each one with a different site held out from training.
    ## Average across them.
    for (otherveg in all_vegtypes[-which(all_vegtypes == targetveg)]){
      
      df <- df %>%
        bind_rows( collect_otherveg_bysite_byveg(otherveg, targetveg, targetsite) )

    }

  }

}

df <- as_tibble(df)

saveRDS(df, file = "data/bias_leave_vegtype_out_cv.csv")
```


```{r}
## Bias on DBF sites
df %>% 
  filter(isveg == "DBF") %>% 
  ggplot(aes(x = bias, y = ..density.., color = trainedonveg)) +
  geom_density() + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  theme_classic() +
  labs(title = "Bias on DBF sites")

## Bias on GRA sites
df %>% 
  filter(isveg == "GRA") %>% 
  ggplot(aes(x = bias, y = ..density.., color = trainedonveg)) +
  geom_density() + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  theme_classic() +
  labs(title = "Bias on GRA sites")

## Bias on ENF sites
df %>% 
  filter(isveg == "ENF") %>% 
  ggplot(aes(x = bias, y = ..density.., color = trainedonveg)) +
  geom_density() + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  theme_classic() +
  labs(title = "Bias on ENF sites")

## Bias on MF sites
df %>% 
  filter(isveg == "MF") %>% 
  ggplot(aes(x = bias, y = ..density.., color = trainedonveg)) +
  geom_density() + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  theme_classic() +
  labs(title = "Bias on MF sites")
```


```{r}
gg1 <- ggplot(dbf, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + ylim(-4,4) +
  labs(title="LGOCV trained on DBF",
       x="Vegetation Type", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       ) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()

gg2 <- ggplot(mf, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + ylim(-4,4) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title="LGOCV trained on MF",
       x="Vegetation Type", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )+ 
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()

gg3 <- ggplot(gra, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + ylim(-4,4) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title="LGOCV trained on GRA",
       x="Vegetation Type", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )+ 
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()

gg4 <- ggplot(enf, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + ylim(-4,4) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(title="LGOCV trained on ENF",
       x="Vegetation Type", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )+ 
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()


plot_grid( gg1, 
           gg2, 
           gg3  ,
           gg4,
           align='v', 
           labels = c('a', 'b', 'c', 'd'), 
           nrow=2, ncol=2
           )
ggsave("fig/lgocv_vegtype.pdf", width = 9, height = 6)
```


## LGOCV: Continent

```{r}
train_eu <- read_csv("data/train_eu.csv")
train_us <- read_csv("data/train_us.csv")

gg1 <- ggplot(train_eu, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  ylim(-6,6) +
  labs(title="LGOCV trained on EU",
       x="Continent", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )+ 
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()

gg2 <- ggplot(train_us, aes(x=group, y=bias)) +
  geom_violin(draw_quantiles =0.5) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  ylim(-6,6) +
  labs(title="LGOCV trained on US",
       x="Continent",
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )+ 
  theme(plot.title = element_text(face="bold")) + 
  theme_classic()

plot_grid(gg1, 
          gg2, 
          labels =c("a","b"),  
          align = "v",
          nrow=1
          )
ggsave("fig/lgocv_continent.pdf", width = 9, height = 3)
```

## Extreme conditions

```{r}
df_extremes <- read_csv("data/dnn_extreme_condition.csv") %>% 
  dplyr::select(-1) %>% 
  mutate(model = "DNN") %>% 
  bind_rows(
    read_csv("data/lstm_extreme_condition.csv") %>% 
      dplyr::select(-1) %>% 
      mutate(model = "LSTM")
  )
  
# dnn_extreme_condition$Model = "DNN"
# lstm_extreme_condition$Model = "LSTM"
# rf_extreme_condition_2$Model = "RF"
# 
# df <- rbind(dnn_extreme_condition, rf_extreme_condition_2)
# df <- rbind(df, lstm_extreme_condition)

gg1 <- ggplot(df_extremes, aes(x=model, y=lower_quantile)) +
  geom_violin(draw_quantiles =0.5) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme_classic() + 
  ylim(-7,4) + 
  labs(title="Negative anomalies",
       x="Model", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )


gg2 <- ggplot(df_extremes, aes(x=model, y=normal)) +
  geom_violin(draw_quantiles =0.5) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme_classic() + 
  ylim(-7,4) + 
  labs(title="Normal ",
       x="Model", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )


gg3 <- ggplot(df_extremes, aes(x=model, y=upper_quantile)) +
  geom_violin(draw_quantiles =0.5) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme_classic() + 
  ylim(-7,4) + 
  labs(title="Positive anomalies",
       x="Model", 
       y = expression(paste("Bias (gC m"^-2, "d"^-1, ")"))
       )

plot_grid( 
  gg1,
  gg2,
  gg3, 
  align='v', 
  labels = c('a', 'b', 'c'), 
  nrow=1
  )
```


### Dry

Do this only within climate zones where a dryness-related bias is evident.

Hypothesis: In Csa, model bias is highest when soil moisture levels are low.

```{r}
## Bin data along deficit and make regression with upper 90% quantile
nbin <- 10
df2 <- df %>%
  ungroup() %>% 
  dplyr::filter(koeppen_code == "Csa") %>%
  mutate(bias_lstm = lstm_cond0 - GPP_NT_VUT_REF,
         bias_dnn = dnn_cond0 - GPP_NT_VUT_REF,
         bias_null = gpp_null - GPP_NT_VUT_REF) %>%
  mutate(bin = cut(wscal, breaks = seq(0.1, 0.9, by = 0.1))) %>% 
  mutate(wscal_lower = as.numeric( sub("\\((.+),.*", "\\1", bin)),
         wscal_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", bin) )
         ) %>% 
  mutate(wscal_mid = (wscal_lower + wscal_upper)/2) %>% 
  mutate(wscal_mid = as.factor(wscal_mid)) %>% 
  dplyr::select(-bin, -wscal_lower, -wscal_upper)
  
df2 %>% 
  ggplot(aes(wscal_mid, bias_lstm)) +
  geom_violin()
```

### Cold stress

Do this only for climate zones where a (early season) temperature-related bias is evident.
Consider min temp of the preceding month.

Hypothesis: In Cfa (temperate, no dry season, hot summer), Dfb (Cold, no dry season, warm summer), Dfc (Cold, no dry season, cold summer), model bias is highest when minimum temperature of preceeding month was lowest (keeping only growing season data)

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  dplyr::filter(koeppen_code %in% c("Cfa", "Dfb", "Dfc")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```


<!-- ## Comparison to physical model -->

<!-- Load out-of-bag (OOB) cross validation results from Stocker et al. (2020) (file `df_metrics_oob_stocker20gmd_fig2.csv`), and from the LSTM. -->
<!-- ```{r cars} -->
<!-- usesites <- df$sitename %>% unique() -->

<!-- df_oob_pmodel <- read_csv("~/mlflx/data/df_metrics_oob_stocker20gmd_fig2.csv") %>%  -->
<!--   filter(site %in% usesites) -->

<!-- df_oob_pmodel -->

<!-- df_oob_pmodel <- read_csv("~/mlflx/data/lstm_100e_r2.csv") %>% -->
<!--   rename(rsq = R2, site = Site) -->
<!-- ``` -->

<!-- Plot histograms of R-squared of OOB-CV for the two. -->
<!-- ```{r pressure, echo=FALSE} -->
<!-- gg1 <- df_oob_pmodel %>%  -->
<!--   ggplot() + -->
<!--   geom_histogram(aes(x = rsq, y = ..count..), -->
<!--     color = "black", alpha = 0.3, binwidth = 0.05,  -->
<!--     position="identity") + -->
<!--   theme_classic() + -->
<!--   labs(x = bquote(italic(R)^2), y = "Count") + -->
<!--   xlim(0.2, 1) -->

<!-- gg2 <- df_oob_mlflx %>%  -->
<!--   ggplot() + -->
<!--   geom_histogram(aes(x = rsq, y = ..count..), -->
<!--     color = "black", alpha = 0.3, binwidth = 0.05,  -->
<!--     position="identity") + -->
<!--   theme_classic() + -->
<!--   labs(x = bquote(italic(R)^2), y = "Count") + -->
<!--   xlim(0.2, 1) -->

<!-- gg1 / gg2 -->
<!-- ``` -->

<!-- This is the plot I sent through Slack. -->
<!-- ```{r pressure, echo=FALSE} -->
<!-- df <- df_oob_pmodel %>%  -->
<!--   rename(rsq_pmodel = rsq) %>%  -->
<!--   full_join(df_oob_mlflx %>% rename(rsq_ml = rsq), by = "site") -->

<!-- df %>%  -->
<!--   ggplot(aes(x = rsq_pmodel, y = rsq_ml, label = site)) + -->
<!--   geom_point(size = 2, color = "red") + -->
<!--   theme_classic() + -->
<!--   geom_abline(slope = 1, intercept = 0, linetype = "dotted") + -->
<!--   xlim(0, 1) + ylim(0, 1) + -->
<!--   geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5) + -->
<!--   labs(x = bquote("Physical model" ~ italic(R)^2), y = bquote("ML" ~ italic(R)^2)) -->

<!-- ggsave("~/mlflx/fig/rsq_oob_comparison.pdf", width = 5, height = 4) -->
<!-- ``` -->


<!-- This is something else I did for myself (beni). -->
<!-- ```{r} -->
<!-- # df_mlflx <- read_csv("~/mlflx/data/ddf_combined_mlflx_20210510.csv") -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(classid == "DBF") %>%  -->
<!-- #   pull(sitename) %>%  -->
<!-- #   unique() -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(sitename == "US-Var") %>%  -->
<!-- #   slice(2000:3600) %>%  -->
<!-- #   ggplot(aes(x = date)) + -->
<!-- #   geom_line(aes(y = GPP_NT_VUT_REF)) -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(sitename == "US-Var") %>%  -->
<!-- #   slice(2000:3600) %>%  -->
<!-- #   ggplot(aes(x = date)) + -->
<!-- #   geom_line(aes(y = fpar)) -->

<!-- df_metrics <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "FR-Pue") %>%  -->
<!--   yardstick::metrics("fpar", "GPP_NT_VUT_REF") %>%  -->
<!--   mutate(sitename = "FR-Pue") %>%  -->
<!--   bind_rows( -->
<!--     df_mlflx %>%  -->
<!--       dplyr::filter(sitename == "CH-Lae") %>%  -->
<!--       yardstick::metrics("fpar", "GPP_NT_VUT_REF") %>%  -->
<!--       mutate(sitename = "CH-Lae") -->
<!--   ) %>%  -->
<!--   dplyr::filter(.metric == "rsq") %>%  -->
<!--   mutate(.estimate = format(.estimate, digits = 2)) -->

<!-- gg1 <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "CH-Lae") %>%  -->
<!--   ggplot(aes(y = GPP_NT_VUT_REF, x = fpar)) + -->
<!--   geom_hex(bins = 30) + -->
<!--   scale_fill_gradientn( -->
<!--     colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5) -->
<!--     # , trans = "log", breaks = c(1, 10) -->
<!--     ) + -->
<!--   theme_classic() + -->
<!--   labs( -->
<!--     title = "Deciduous forest: CH-Lae",  -->
<!--     subtitle = bquote( italic(R)^2 == .(df_metrics %>% dplyr::filter( sitename == "CH-Lae") %>% pull(.estimate))), -->
<!--     y = expression(paste("GPP (gC m"^-2, "s"^-1, ")")), x = "MODIS EVI") + -->
<!--   theme_classic() +  -->
<!--   geom_smooth(method='lm', color="red", size=0.5, se=FALSE) -->

<!-- gg2 <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "FR-Pue") %>%  -->
<!--   ggplot(aes(y = GPP_NT_VUT_REF, x = fpar)) + -->
<!--   geom_hex(bins = 30) + -->
<!--   scale_fill_gradientn( -->
<!--     colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5) -->
<!--     # , trans = "log", breaks = c(1, 10) -->
<!--     ) + -->
<!--   theme_classic() + -->
<!--   labs( -->
<!--     title = "Evergreen forest: FR-Pue",  -->
<!--     subtitle = bquote( italic(R)^2 == .(df_metrics %>% dplyr::filter( sitename == "FR-Pue") %>% pull(.estimate))), -->
<!--     y = expression(paste("GPP (gC m"^-2, "s"^-1, ")")), x = "MODIS EVI") + -->
<!--   theme_classic()  -->

<!-- gg1 + gg2 -->
<!-- ggsave("~/polybox/fig/gpp_evi.pdf", width = 8, height = 4) -->
<!-- ``` -->
