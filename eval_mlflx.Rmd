---
title: "Evaluate mlflx"
author: "Beni Stocker"
date: "5/22/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(ggrepel)
library(rbeni)    # get it by devtools::install_github("https://github.com/stineb/rbeni.git")
library(ingestr)  # get it by devtools::install_github("https://github.com/computationales/ingestr.git")
```

## LSOCV metrics

### Read in

Obtain outputs with this [link on Notion](https://www.notion.so/computationales/Results-2a637978b16346f98ac8c8c018ee7549#68803d0d60ca4b35b331be78c695a97c).
```{r}
df <- read_csv("data/df_pred_denormalised.csv")  # obtained from Notion -> mlflx DSLab -> Results -> 
```

```{r}
visdat::vis_miss(df, warn_large_data = FALSE, cluster = FALSE)
```

<!-- ```{r} -->
<!-- df_train <- read_csv("data/ddf_combined_mlflx_20210510.csv") -->
<!-- ``` -->

### Daily 
```{r}
out_lstm <- df %>% 
  analyse_modobs2("LSTM_de", "GPP_NT_VUT_REF", type = "hex")
out_dnn <- df %>% 
  analyse_modobs2("DNN_de", "GPP_NT_VUT_REF", type = "hex")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")

gg1 + gg2
```


### Seasonal

```{r}
df_season <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  group_by(sitename, doy) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), lstm = mean(LSTM_de, na.rm = TRUE), dnn = mean(DNN_de, na.rm = TRUE))
```

<!-- Practically o missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_season) -->
<!-- ``` -->

Agreement of mean seasonal cycles.
```{r}
out_lstm <- df_season %>% rbeni::analyse_modobs2("lstm", "obs", type = "hex")
out_dnn <- df_season %>% rbeni::analyse_modobs2("dnn", "obs", type = "hex")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")

gg1 + gg2
```


Nash-Sutcliffe Efficiency (for comparison to Besnard et al., 2019: they had 0.66)
```{r}
hydroGOF::NSE(df_season$dnn, df_season$obs, na.rm = TRUE)
hydroGOF::NSE(df_season$lstm, df_season$obs, na.rm = TRUE)
```

#### By climate zone

```{r}
df_season_kgclimate <- df %>% 
  left_join(
    siteinfo_fluxnet2015,
    by = "sitename"
  ) %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  group_by(koeppen_code, doy) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), lstm = mean(LSTM_de, na.rm = TRUE), dnn = mean(DNN_de, na.rm = TRUE))
```

Seasonal course by climate zone: LSTM works much better.
```{r}
df_season_kgclimate %>% 
  filter(koeppen_code != "-") %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black"), labels = c("DNN", "LSTM", "obs.")) +
  facet_wrap(~koeppen_code)
```

LSTM performs better in different aspects, possibly due to different processes inducing different temporal dependencies in different climate zones. DNN (but not or to a lesser degree LSTM) simulates:

- Aw (tropical savannah): too early recovery of GPP in wet season.
- Cfa (temperate, no dry season, hot summer), Dfb (Cold, no dry season, warm summer), Dfc (Cold, no dry season, cold summer): too early recovery of GPP in spring
- Csa (temperate, dry summer, hot summer): underestimating peak GPP, not fast enough depression of GPP after peak season

These are exemplified by looking at individual sites.

- Aw (tropical savannah): too early recovery of GPP in wet season.

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  filter(koeppen_code %in% c("Aw")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

- Cfa (temperate, no dry season, hot summer), Dfb (Cold, no dry season, warm summer), Dfc (Cold, no dry season, cold summer): too early recovery of GPP in spring

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  filter(koeppen_code %in% c("Cfa", "Dfb", "Dfc")) %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

- Csa (temperate, dry summer, hot summer): underestimating peak GPP, not fast enough depression of GPP after peak season

```{r}
df_season %>% 
  left_join(siteinfo_fluxnet2015, by = "sitename") %>% 
  filter(koeppen_code == "Csa") %>%
  pivot_longer(c(obs, lstm, dnn), names_to = "source", values_to = "gpp") %>% 
  ggplot(aes(doy, gpp, color = source)) +
  geom_line() +
  scale_color_manual(values = c("dnn" = "royalblue", "lstm" = "red", "obs" = "black")) +
  facet_wrap(~sitename)
```

### Daily anomalies

Anomalies from mean seasonal cycle.

```{r}
df_anom <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  left_join(df_season,
            by = c("sitename", "doy")) %>% 
  mutate(obs_anom = GPP_NT_VUT_REF - obs,
         lstm_anom = LSTM_de - lstm,
         dnn_anom = DNN_de - dnn)


out_lstm <- df_anom %>% 
  dplyr::select(mod = lstm_anom, obs = obs_anom) %>% 
  analyse_modobs2("mod", "obs", type = "hex")
out_dnn  <- df_anom %>% 
  dplyr::select(mod = dnn_anom, obs = obs_anom) %>% 
  analyse_modobs2("mod", "obs", type = "hex")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")

gg1 + gg2

hydroGOF::NSE(df_anom$lstm_anom, df_anom$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_anom$dnn_anom, df_anom$obs_anom, na.rm = TRUE)
```


<!-- ```{r} -->
<!-- out_msc  <- df_anom %>% rbeni::analyse_modobs2("obs", "GPP_NT_VUT_REF", type = "hex") -->
<!-- out_msc$gg -->

<!-- gg1 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, lstm)) + -->
<!--   geom_line(aes(date, GPP_NT_VUT_REF), color = "red", alpha = 0.5) -->

<!-- gg2 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, obs_anom)) -->

<!-- gg3 <- df_anom %>%  -->
<!--   filter(sitename == "US-Ha1") %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(date, lstm_anom)) -->

<!-- gg1 / gg2 / gg3 -->

<!-- df_anom %>%  -->
<!--   ggplot(aes(obs_anom, lstm_anom)) + -->
<!--   geom_point(alpha = 0.2) -->

<!-- df_anom %>%  -->
<!--   dplyr::select(mod = lstm_anom, obs = obs_anom) %>%  -->
<!--   analyse_modobs2("mod", "obs", type = "hex") -->
<!-- ``` -->


### Across-site

Get site means
```{r}
df_site <- df %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  group_by(sitename) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = TRUE), lstm = mean(LSTM_de, na.rm = TRUE), dnn = mean(DNN_de, na.rm = TRUE))
```

<!-- No missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_site) -->
<!-- ``` -->

Agreement of site means
```{r}
out_lstm <- df_site %>% 
  rbeni::analyse_modobs2("lstm", "obs")
out_dnn <- df_site %>% 
  rbeni::analyse_modobs2("dnn", "obs")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")

gg1 + gg2
```

Nash-Sutcliffe Efficiency (for comparison to Besnard et al., 2019: they had 0.42)
```{r}
hydroGOF::NSE(df_site$dnn, df_site$obs, na.rm = TRUE)
hydroGOF::NSE(df_site$lstm, df_site$obs, na.rm = TRUE)
```

### Annual

Get site means
```{r}
df_ann <- df %>%
  mutate(doy = lubridate::yday(date)) %>% 
  ## fill with mean seasonal cycle for missing observations
  left_join(df_season %>% 
              rename(obs_meandoy = obs, lstm_meandoy = lstm, dnn_meandoy = dnn), 
            by = c("sitename", "doy")) %>% 
  mutate(GPP_NT_VUT_REF = ifelse(is.na(GPP_NT_VUT_REF), obs_meandoy, GPP_NT_VUT_REF)) %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(sitename, year) %>% 
  summarise(obs = mean(GPP_NT_VUT_REF, na.rm = FALSE), lstm = mean(LSTM_de, na.rm = FALSE), dnn = mean(DNN_de, na.rm = FALSE))
```

<!-- No missing data -->
<!-- ```{r} -->
<!-- visdat::vis_miss(df_ann) -->
<!-- ``` -->

### Annual anomalies

```{r}
df_ann <- df_ann %>% 
  left_join(df_ann %>% 
              group_by(sitename) %>% 
              summarise(obs_mean = mean(obs, na.rm = TRUE), lstm_mean = mean(lstm, na.rm = TRUE), dnn_mean = mean(dnn, na.rm = TRUE)),
            by = c("sitename")) %>% 
  mutate(obs_anom = obs - obs_mean,
         lstm_anom = lstm - lstm_mean,
         dnn_anom = dnn - dnn_mean)

out_lstm <- df_ann %>% 
  dplyr::select(mod = lstm_anom, obs = obs_anom) %>% 
  rbeni::analyse_modobs2("mod", "obs")
out_dnn <- df_ann %>% 
  dplyr::select(mod = dnn_anom, obs = obs_anom) %>% 
  rbeni::analyse_modobs2("mod", "obs")

gg1 <- out_lstm$gg +
  labs(title = "LSTM")
gg2 <- out_dnn$gg +
  labs(title = "DNN")

gg1 + gg2
```

Besnard et al; 0.07
```{r}
hydroGOF::NSE(df_ann$dnn_anom, df_ann$obs_anom, na.rm = TRUE)
hydroGOF::NSE(df_ann$lstm_anom, df_ann$obs_anom, na.rm = TRUE)
```

<!-- ## Comparison to physical model -->

<!-- Load out-of-bag (OOB) cross validation results from Stocker et al. (2020) (file `df_metrics_oob_stocker20gmd_fig2.csv`), and from the LSTM. -->
<!-- ```{r cars} -->
<!-- df_oob_pmodel <- read_csv("~/mlflx/data/df_metrics_oob_stocker20gmd_fig2.csv") -->
<!-- df_oob_mlflx <- read_csv("~/mlflx/data/lstm_100e_r2.csv") %>%  -->
<!--   rename(rsq = R2, site = Site) -->
<!-- ``` -->

<!-- Plot histograms of R-squared of OOB-CV for the two. -->
<!-- ```{r pressure, echo=FALSE} -->
<!-- gg1 <- df_oob_pmodel %>%  -->
<!--   ggplot() + -->
<!--   geom_histogram(aes(x = rsq, y = ..count..), -->
<!--     color = "black", alpha = 0.3, binwidth = 0.05,  -->
<!--     position="identity") + -->
<!--   theme_classic() + -->
<!--   labs(x = bquote(italic(R)^2), y = "Count") + -->
<!--   xlim(0.2, 1) -->

<!-- gg2 <- df_oob_mlflx %>%  -->
<!--   ggplot() + -->
<!--   geom_histogram(aes(x = rsq, y = ..count..), -->
<!--     color = "black", alpha = 0.3, binwidth = 0.05,  -->
<!--     position="identity") + -->
<!--   theme_classic() + -->
<!--   labs(x = bquote(italic(R)^2), y = "Count") + -->
<!--   xlim(0.2, 1) -->

<!-- gg1 / gg2 -->
<!-- ``` -->

<!-- This is the plot I sent through Slack. -->
<!-- ```{r pressure, echo=FALSE} -->
<!-- df <- df_oob_pmodel %>%  -->
<!--   rename(rsq_pmodel = rsq) %>%  -->
<!--   full_join(df_oob_mlflx %>% rename(rsq_ml = rsq), by = "site") -->

<!-- df %>%  -->
<!--   ggplot(aes(x = rsq_pmodel, y = rsq_ml, label = site)) + -->
<!--   geom_point(size = 2, color = "red") + -->
<!--   theme_classic() + -->
<!--   geom_abline(slope = 1, intercept = 0, linetype = "dotted") + -->
<!--   xlim(0, 1) + ylim(0, 1) + -->
<!--   geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5) + -->
<!--   labs(x = bquote("Physical model" ~ italic(R)^2), y = bquote("ML" ~ italic(R)^2)) -->

<!-- ggsave("~/mlflx/fig/rsq_oob_comparison.pdf", width = 5, height = 4) -->
<!-- ``` -->


<!-- This is something else I did for myself (beni). -->
<!-- ```{r} -->
<!-- # df_mlflx <- read_csv("~/mlflx/data/ddf_combined_mlflx_20210510.csv") -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(classid == "DBF") %>%  -->
<!-- #   pull(sitename) %>%  -->
<!-- #   unique() -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(sitename == "US-Var") %>%  -->
<!-- #   slice(2000:3600) %>%  -->
<!-- #   ggplot(aes(x = date)) + -->
<!-- #   geom_line(aes(y = GPP_NT_VUT_REF)) -->
<!-- #  -->
<!-- # df_mlflx %>%  -->
<!-- #   dplyr::filter(sitename == "US-Var") %>%  -->
<!-- #   slice(2000:3600) %>%  -->
<!-- #   ggplot(aes(x = date)) + -->
<!-- #   geom_line(aes(y = fpar)) -->

<!-- df_metrics <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "FR-Pue") %>%  -->
<!--   yardstick::metrics("fpar", "GPP_NT_VUT_REF") %>%  -->
<!--   mutate(sitename = "FR-Pue") %>%  -->
<!--   bind_rows( -->
<!--     df_mlflx %>%  -->
<!--       dplyr::filter(sitename == "CH-Lae") %>%  -->
<!--       yardstick::metrics("fpar", "GPP_NT_VUT_REF") %>%  -->
<!--       mutate(sitename = "CH-Lae") -->
<!--   ) %>%  -->
<!--   dplyr::filter(.metric == "rsq") %>%  -->
<!--   mutate(.estimate = format(.estimate, digits = 2)) -->

<!-- gg1 <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "CH-Lae") %>%  -->
<!--   ggplot(aes(y = GPP_NT_VUT_REF, x = fpar)) + -->
<!--   geom_hex(bins = 30) + -->
<!--   scale_fill_gradientn( -->
<!--     colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5) -->
<!--     # , trans = "log", breaks = c(1, 10) -->
<!--     ) + -->
<!--   theme_classic() + -->
<!--   labs( -->
<!--     title = "Deciduous forest: CH-Lae",  -->
<!--     subtitle = bquote( italic(R)^2 == .(df_metrics %>% dplyr::filter( sitename == "CH-Lae") %>% pull(.estimate))), -->
<!--     y = expression(paste("GPP (gC m"^-2, "s"^-1, ")")), x = "MODIS EVI") + -->
<!--   theme_classic() +  -->
<!--   geom_smooth(method='lm', color="red", size=0.5, se=FALSE) -->

<!-- gg2 <- df_mlflx %>%  -->
<!--   dplyr::filter(sitename == "FR-Pue") %>%  -->
<!--   ggplot(aes(y = GPP_NT_VUT_REF, x = fpar)) + -->
<!--   geom_hex(bins = 30) + -->
<!--   scale_fill_gradientn( -->
<!--     colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5) -->
<!--     # , trans = "log", breaks = c(1, 10) -->
<!--     ) + -->
<!--   theme_classic() + -->
<!--   labs( -->
<!--     title = "Evergreen forest: FR-Pue",  -->
<!--     subtitle = bquote( italic(R)^2 == .(df_metrics %>% dplyr::filter( sitename == "FR-Pue") %>% pull(.estimate))), -->
<!--     y = expression(paste("GPP (gC m"^-2, "s"^-1, ")")), x = "MODIS EVI") + -->
<!--   theme_classic()  -->

<!-- gg1 + gg2 -->
<!-- ggsave("~/polybox/fig/gpp_evi.pdf", width = 8, height = 4) -->
<!-- ``` -->
